<p align="center">
  <img alt="OpenCVE" src="https://raw.githubusercontent.com/opencve/opencve/master/logo.png">
</p>

## OpenCVE Docker

This repository contains the files to install and run OpenCVE with Docker, feel free to contribute.

We provide a [documentation](https://docs.opencve.io/installation/docker/) with the details of each step.

## Installation

### Manual

```cmd
git clone https://github.com/marsvillager/opencve.git
git checkout -b discover origin/cve_discover

# 注：MaskupSafe 和 Werkzeug 根据本地 python 版本可能存在版本不合适问题（官方 3.8.17），可以先安装最新版本的 MaskupSafe 和 Werkzeug，成功安装 opencve 之后再卸载之前版本并安装 MaskupSafe 和 Werkzeug
pip install opencve

# Configuration file
export OPENCVE_HOME=./conf
opencve init

# Initialize the database
vim ~/opencve/opencve.cfg
...
database_uri = postgresql://john:mysupersecret@servername:5432/opencve
...
export FLASK_APP=./opencve/app.py
flask db upgrade

# Import the data
opencve import-data
opencve upgrade-endpoint
opencve upgrade-result

# Export the data
opencve export-affected-cves
- endpoint mac address:
- the possibility threshold:
opencve export-victim [POSSIBILITY]

# Start the workers
vim ~/opencve/opencve.cfg
...
celery_broker_url = redis://127.0.0.1:6379/0
celery_result_backend = redis://127.0.0.1:6379/1
...
opencve celery worker -l INFO
opencve celery beat -l INFO

# Create an admin
opencve create-user john john.doe@example.com --admin

# Start the webserver
opencve webserver -b [ip:port]
```

### Docker

```cmd
# Configuration
git clone https://github.com/marsvillager/opencve-docker.git
git checkout -b discover origin/discover

cd opencve-docker && cp ./conf/opencve.cfg.example ./conf/opencve.cfg

# Initialize the stack
sudo docker-compose build
sudo docker-compose up -d postgres redis webserver celery_worker

# Initialize the database
sudo docker exec -it webserver flask db upgrade

# Import the data
sudo docker exec -it webserver opencve import-data
sudo docker exec -it webserver opencve upgrade-endpoint
sudo docker exec -it webserver opencve upgrade-result

# Export the data
sudo docker exec -it webserver opencve export-affected-cves
- endpoint mac address:
- the possibility threshold:
sudo docker exec -it webserver opencve export-victim [POSSIBILITY]

# Start the beat
sudo docker-compose up -d celery_beat

# Create an admin
sudo docker exec -it webserver opencve create-user john john.doe@example.com --admin
```

## 配置文件路径问题

`./opencve/commands/upgrade_endpoint.py` 中 `upgrade_endpoint()` 函数：

- Manual 路径是 `OPENCVE_HOME + '/records.jsonl'`（`OPENCVE_HOME=./conf`）
- Docker 路径是 `/app/records.jsonl`
